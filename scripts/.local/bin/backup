#!/bin/sh
set -e

# Settings
BACKUP_DIR=~/Backups
COMPRESSION_LEVEL="6" # 1 to 9
COMPRESSION_LEVEL_ZSTD="3" # 1 to 19
PROCESSES=$(nproc)

display_help() {
    echo "Usage: $(basename "$0") [FILE] [gzip|bzip2|zstd|zip]"
    exit 2
}

configure_backup_dir() {
    mkdir -p "${BACKUP_DIR}"
}

backup() {
    directory=0
    
    # assert file exists
    # if its directory = 1

    input="${1%/}" # strip trailing slash

    compression=$2
    timestamp=$(date +'%F-%Hh%M')
    backup_filename="${BACKUP_DIR}/${input}_${timestamp}"
    
    echo "Initial size: $(du -sh "${input}")"

    case "$compression" in
        gzip)
            echo "Begin compression with gzip..."
            if [ -d "$input" ]; then
                extension="tar.gz"
                tar --use-compress-program="pigz -k -p ${PROCESSES} -${COMPRESSION_LEVEL}" -cvf \
                    "${backup_filename}.${extension}" -C "$(dirname "${input}")" "$(basename "${input}")"
            else
                extension="gz"
                tar --use-compress-program="pigz -k -p ${PROCESSES} -${COMPRESSION_LEVEL}" -cvf \
                    "${backup_filename}.${extension}" "${input}"
            fi
            ;;
        bzip2)
            echo "Begin compression with bzip2..."
            if [ -d "$input" ]; then
                extension="tar.bz2"
                tar --use-compress-program="pbzip2 -k -p${PROCESSES} -${COMPRESSION_LEVEL}" -cvf \
                    "${backup_filename}.${extension}" -C "$(dirname "${input}")" "$(basename "${input}")"
            else
                extension="bz2"
                tar --use-compress-program="pbzip2 -k -p${PROCESSES} -${COMPRESSION_LEVEL}" -cvf \
                    "${backup_filename}.${extension}" "${input}"
            fi
            ;;
        zstd)
            echo "Begin compression with zstd..."
            if [ -d "$input" ]; then
                extension="tar.zst"
                tar --use-compress-program="zstd -v -T${PROCESSES} -${COMPRESSION_LEVEL_ZSTD}" -cvf \
                    "${backup_filename}.${extension}" -C "$(dirname "${input}")" "$(basename "${input}")"
            else
                extension="zst"
                zstd -v -T"${PROCESSES}" -"${COMPRESSION_LEVEL_ZSTD}" -o "${backup_filename}.${extension}" "${input}"
            fi
            ;;
        zip)
            echo "Begin compression with zip..."
            extension="zip"
            zip -rv -"${COMPRESSION_LEVEL}" "${backup_filename}.${extension}" "${input}"
            ;;
        *)
            echo "Error: Invalid compression option."
            display_help
            ;;
    esac
    
    echo "Backup created: $(du -h "${backup_filename}.${extension}")"
    exit 0
}

configure_backup_dir

if [ "$#" -ne 2 ]; then
    display_help
fi

backup "$1" "$2"
