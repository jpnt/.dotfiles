#!/bin/sh
# jpstack: install my collection of software, no fancy stuff
# made for Void Linux after a fresh install
# !!!!!!!!!!!!!!!!!!!!!!!!
# !!! WORK IN PROGRESS !!!
# !!!!!!!!!!!!!!!!!!!!!!!!

set -e

# TODO
# PKG_STACK_XBPS="stow xtools tealdeer handlr bash-completion git tig vis imv dragon fcft-devel tlp powertop lm_sensors gammastep foot dtach xdg-user-dirs xdg-desktop-portal-wlr xdg-desktop-portal-gtk wlroots0.18-devel xorg-server-xwayland xwininfo wlr-randr wl-clipboard dejavu-fonts-ttf noto-fonts-ttf noto-fonts-cjk noto-fonts-emoji nerd-fonts-ttf socklog-void pcmanfm grim slurp pipewire flatpak alsa-utils seatd turnstile cmus socat NetworkManager qt5-wayland qt6-wayland adwaita-qt adwaita-qt6 tofi ripgrep fzf podman mpv ffmpeg cronie ntpd-rs catgirl pcmanfm htop btop nvtop uv trash-cli cmus syncthing keepassxc tcpdump strace zathura-pdf-mupdf"

# GPU_AMD="mesa-dri vulkan-loader mesa-vulkan-radeon mesa-vaapi mesa-vdpau"

USER=$(whoami)
GROUPS="_seatd input video socklog"
DISABLE_SERVICES="dhcpcd wpa_supplicant agetty-tty4 agetty-tty5 agetty-tt6 agetty"
ENABLE_SERVICES="NetworkManager"
JPSTACK_DIR="${HOME}/Coding/jpstack"

make_clean_install() {
	cd "$1"
	make clean
	make -j$(nproc)
	sudo make install
	cd ..
}

meson_ninja_install() {
	cd "$1"
	meson setup build
	ninja -C build
	ninja -C build install
	cd ..
}

# Install system packages
sudo xbps-install -Suvy "$@"

# Create XDG user directories
xdg-user-dirs-update

# Add user to groups
# todo: for group in GROUPS
usermod -aG ${group} ${USER}

# Disable services
# todo: for service in DISABLE_SERVICES
[ -h /var/service/${service} ] && sudo sv stop ${service} && sudo unlink /var/service/${service}

# Enable services
# todo: for service in ENABLE_SERVICES
[ ! -h /var/service/${SERVICE} ] && sudo ln -s /etc/sv/${SERVICE} /var/service/${SERVICE} && sudo start ${SERVICE}

# Install flatpak packages
flatpak remote-add --if-not-exists --user flathub https://dl.flathub.org/repo/flathub.flatpakrepo
flatpak install flathub com.github.tchx86.Flatseal
flatpak install flathub io.gitlab.librewolf-community
flatpak install flathub com.saivert.pwvucontrol
flatpak install flathub io.github.dimtpap.coppwr

# Create directory for compiled packages
mkdir -p "${JPSTACK_DIR}"
cd "${JPSTACK_DIR}"

git clone "https://github.com/jpnt/sfm"
make_clean_install sfm

git clone "https://github.com/jpnt/slstatus"
make_clean_install slstatus

git clone "https://github.com/jpnt/dwl"
make_clean_install dwl

