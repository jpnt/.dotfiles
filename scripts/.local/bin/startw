#!/bin/sh
# startw - Wayland session starter (POSIX-compliant)
# Usage: startw [options] [client-args...]

VERSION="1.0"
DEFAULT_CONFIG="${HOME}/.winitrc"
COMPOSITOR="sway"  # Default compositor if not specified in config

# Environment setup
export XDG_SESSION_TYPE=wayland
export GDK_BACKEND=wayland
export QT_QPA_PLATFORM=wayland-egl
export MOZ_ENABLE_WAYLAND=1

# POSIX-compliant error handling
die() {
    printf "%s\n" "$*" >&2
    exit 1
}

# POSIX-compliant version check
version() {
    printf "startw version %s\n" "$VERSION"
    exit 0
}

usage() {
    printf "Usage: %s [-v] [-h] [-c config] [-- compositor-args...]\n" "$0"
    printf "Options:\n"
    printf "  -h          Show this help\n"
    printf "  -v          Show version\n"
    printf "  -c config   Use specified config file\n"
    exit 0
}

# Parse arguments
while getopts ":hvc:" opt; do
    case $opt in
        h) usage ;;
        v) version ;;
        c) DEFAULT_CONFIG=$OPTARG ;;
        \?) die "Invalid option: -$OPTARG" ;;
        :) die "Option -$OPTARG requires an argument" ;;
    esac
done
shift $((OPTIND - 1))

# Session validation
if [ -n "$WAYLAND_DISPLAY" ] || [ -n "$DISPLAY" ]; then
    die "Already in a graphical session!"
fi

# TTY check
tty_device=$(tty) || die "Cannot determine TTY device"
case $tty_device in
    /dev/tty[0-9]*);;
    *) die "Must be run from a virtual terminal (tty)" ;;
esac

# XDG runtime directory setup
if [ -z "$XDG_RUNTIME_DIR" ]; then
    XDG_RUNTIME_DIR="/tmp/$(id -u)-runtime-dir"
    mkdir -p -m 0700 "$XDG_RUNTIME_DIR" || die "Failed to create XDG_RUNTIME_DIR"
    export XDG_RUNTIME_DIR
fi

# Load user config if exists
if [ -f "$DEFAULT_CONFIG" ]; then
    . "$DEFAULT_CONFIG"
else
    printf "No config found at %s, using defaults\n" "$DEFAULT_CONFIG" >&2
fi

# Find compositor
if ! command -v "$COMPOSITOR" >/dev/null 2>&1; then
    die "Compositor '%s' not found in PATH" "$COMPOSITOR"
fi

# Start compositor with remaining arguments
printf "Starting %s Wayland compositor...\n" "$COMPOSITOR"
exec "$COMPOSITOR" "$@"
